(()=>{var e={75:(e,t,r)=>{"use strict";r.r(t);const n=require("dotenv");var o=r.n(n);const s=require("express");var a=r.n(s);const i=require("mongoose");var c=r.n(i),u=r(998);const d=require("https-proxy-agent"),l=require("axios"),g=r.n(l)().create({timeout:5e4});g.interceptors.request.use((e=>(e=>("post"==e.method&&(e.data=e.params),e))(e)),(e=>Promise.reject(e))),g.interceptors.response.use((e=>e.data),(e=>Promise.reject(e)));const h=g;var p=r(671),m=r(998);const w=new class{constructor(){}async OpenAI2DChatGPT(e,t,r){const{text:n}=e.query,o=p.env.OPENAI_API2D_KEY;m.log("apiKey",o);const s=JSON.stringify({model:"gpt-3.5-turbo",max_tokens:150,messages:[{role:"user",content:n}]}),a=await h({url:"https://openai.api2d.net/v1/chat/completions",method:"post",params:s,headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`}});let i="";m.log("result",a.choices[0].message);try{a.choices?i=a.choices[0].message&&a.choices[0].message.content.replace(/^\n+|\n+$/g,""):m.log(`Something went wrong,Code: ${a.status}, ${a.statusText}`)}catch(e){e.request&&m.log("请求出错")}m.log(i),t.send({code:200,message:"请求成功",result:i})}async OpenAIChatGPT(e,t,r){m.log(n);const n=p.env.OPENAI_API_KEY;new d.HttpsProxyAgent("http://u1883940892591256+France:hOIunTn8HjHv@54.174.101.70:36000")}async BingChatGPT(e,t,r){const n=new BingChat({cookie:p.env.BING_COOKIE}),o=await n.sendMessage("Hello World!");m.log(o.text)}},f=a().Router();f.get("/open_ai2d_chatgpt",w.OpenAI2DChatGPT);const y=f,_=require("time-formater");var v=r.n(_);const E=new(0,c().Schema)({id:Number,rank:Number,user_name:String,integral:Number,create_time:String,city:{name:String,longitude:String,latitude:String},wx_id:String});E.index({id:1});const T=c().model("User",E),O=new(0,c().Schema)({user_id:Number}),b=c().model("Ids",O);b.findOne().then((e=>{e||new b({user_id:0}).save()})).catch((e=>{throw new Error(e)}));const x=b;var A=r(998);const I=class{constructor(){this.idlist=["user_id"],this.getId=this.getId.bind(this)}async getId(e){if(!this.idlist.includes(e))throw A.log("id类型错误"),new Error("id类型错误");try{const t=await x.findOne();return t[e]++,await t.save(),t[e]}catch(e){throw A.log("获取ID数据失败"),new Error(e)}}};var P=r(998);const k=new class extends I{constructor(){super(),this.registerUser=this.registerUser.bind(this),this.updataIntegral=this.updataIntegral.bind(this)}async registerUser(e,t,r){const{user_name:n,wx_id:o}=e.body;try{if(!n)throw new Error("缺少参数：用户名不能为空");if(!o)throw new Error("缺少参数：微信ID不能为空");if(await T.findOne({wx_id:o},"-_id -__v"))throw new Error("注册失败，用户已经被注册");let s={user_name:n,id:await this.getId("user_id"),integral:0,create_time:v()().format("YYYY-MM-DD HH:mm:ss"),rank:-1,city:{name:"",longitude:0,latitude:0},wx_id:o};await T.create(s),t.send({code:200,message:"注册成功"}),await this.updataUserRank(e,t,r)}catch(e){return P.log("什么错误:",e),void t.send({code:0,message:e.message})}}async userInfo(e,t,r){const{wx_id:n}=e.query;try{const e=await T.findOne({wx_id:n},"-_id -__v");t.send({code:200,result:e})}catch(e){return P.log(e),void t.send({code:10001,message:e.message})}}async userRankingList(e,t,r){try{const e=await T.find({},"-_id -__v").sort({integral:-1});let r="";e.forEach(((e,t)=>{r+=`${t+1} 、${e.user_name} --- ${e.integral} \n`})),t.send({code:200,message:"获取用户列表",result:r})}catch(e){return P.log(e),void t.send({code:0,message:e.message})}}async updataUserRank(e,t,r){try{const e=await T.find({}).sort({integral:-1});let t=!0;return e.forEach((async(e,r)=>{e.rank!=r+1&&await T.updateOne({_id:e._id},{$set:{rank:r+1}}).then((()=>{P.log(`更新排序 ${e._id}成功`)})).catch((r=>{P.error(`更新 ${e._id} 失败`,r),t=!1}))})),t}catch(e){return P.error(e),void t.send({code:0,message:e.message})}}async updataIntegral(e,t,r){const{type:n=0,wx_id:o}=e.query;let s=0==n?1:-1;try{const n=await T.updateOne({wx_id:o},{$inc:{integral:s}});t.send({code:200,message:"更新成功",result:n}),n.acknowledged&&await this.updataUserRank(e,t,r)}catch(e){return void t.send({code:0,message:e.message})}}async updataCity(e,t,r){const{wx_id:n,area:o,location:s}=e.query,[a,i]=s.split(",");try{const e=await T.updateOne({wx_id:n},{$set:{city:{name:o,longitude:a,latitude:i}}},{multi:!1});t.send({code:200,message:"地址保存成功了耶",result:e})}catch(e){return void t.send({code:0,message:e.message})}}},S=a().Router();S.post("/register_user",k.registerUser),S.get("/user_info",k.userInfo),S.get("/user_ranking_list",k.userRankingList),S.get("/updata_user_rank",k.updataUserRank),S.get("/updata_integral",k.updataIntegral),S.get("/updata_city",k.updataCity);const C=S;var q=r(671),N=r(998);const R=new class{constructor(){this.location="120.151667,30.169379",this.weatherkey=q.env.OPENWEATHER_API_KEY,this.gaodekey=q.env.OPENGAODE_WEB_SERVICE_API_KEY}async weatherForecast(e,t,r){const{lat:n,lon:o}=e.query,s=q.env.OPENWEATHER_API_KEY;try{const e=await h({url:"https://api.openweathermap.org/data/3.0/onecall",method:"get",params:{appid:s,lat:n||"30.169379",lon:o||"120.151667",exclude:"minutely",units:"metric",lang:"zh_cn"}});t.send({code:200,result:e})}catch(e){return void t.send({code:200,message:"请求天气报错了"})}}async latitudeAndLongitude(e,t,r){const n=q.env.OPENGAODE_WEB_SERVICE_API_KEY,{area:o}=e.query;try{let e=o.trim(),r=(await h({url:"https://restapi.amap.com/v3/geocode/geo",method:"get",params:{key:n,address:e}})).geocodes[0];t.send({code:200,message:"我已经记录下来啦！",result:r})}catch(e){return N.log(e),void t.send({code:10001,message:"请求经纬度报错了！,你没有骗我吧，你确定有这个地名"})}}},$=a().Router();$.get("/geocode",R.latitudeAndLongitude),$.get("/weather_forecast",R.weatherForecast);const D=$;var U=r(998);o().config();const j=a()();j.all("*",((e,t,r)=>{const{origin:n,Origin:o,referer:s,Referer:a}=e.headers,i=n||o||s||a||"*";t.header("Access-Control-Allow-Origin",i),t.header("Access-Control-Allow-Headers","Content-Type, Authorization, X-Requested-With"),t.header("Access-Control-Allow-Methods","PUT,POST,GET,DELETE,OPTIONS"),t.header("Access-Control-Allow-Credentials",!0),"OPTIONS"==e.method?t.sendStatus(200):r()}));const L={port:8001,url:"mongodb://localhost:27017/weChat"};j.use(a().json()),(e=>{e.use(C),e.use(y),e.use(D)})(j),(e=>{c().connect(e.url,{useNewUrlParser:!0,useUnifiedTopology:!0}),c().Promise=r.g.Promise;const t=c().connection;t.once("open",(()=>{u.log("连接数据库成功")})),t.on("error",(e=>{u.error("Error in MongoDb connection: "+e),c().disconnect()})),t.on("close",(()=>{u.log("数据库断开，重新连接数据库"),c().connect(e.url,{server:{auto_reconnect:!0}})}))})(L),j.listen(L.port,(()=>{U.log(`${L.port}端口：监听打开了`)}))},998:(e,t,r)=>{var n=r(464),o=r(84);function s(){return(new Date).getTime()}var a,i=Array.prototype.slice,c={};a=void 0!==r.g&&r.g.console?r.g.console:"undefined"!=typeof window&&window.console?window.console:{};for(var u=[[function(){},"log"],[function(){a.log.apply(a,arguments)},"info"],[function(){a.log.apply(a,arguments)},"warn"],[function(){a.warn.apply(a,arguments)},"error"],[function(e){c[e]=s()},"time"],[function(e){var t=c[e];if(!t)throw new Error("No such label: "+e);delete c[e];var r=s()-t;a.log(e+": "+r+"ms")},"timeEnd"],[function(){var e=new Error;e.name="Trace",e.message=n.format.apply(null,arguments),a.error(e.stack)},"trace"],[function(e){a.log(n.inspect(e)+"\n")},"dir"],[function(e){if(!e){var t=i.call(arguments,1);o.ok(!1,n.format.apply(null,t))}},"assert"]],d=0;d<u.length;d++){var l=u[d],g=l[0],h=l[1];a[h]||(a[h]=g)}e.exports=a},671:e=>{var t,r,n=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(e){if(t===setTimeout)return setTimeout(e,0);if((t===o||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(r){try{return t.call(null,e,0)}catch(r){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:o}catch(e){t=o}try{r="function"==typeof clearTimeout?clearTimeout:s}catch(e){r=s}}();var i,c=[],u=!1,d=-1;function l(){u&&i&&(u=!1,i.length?c=i.concat(c):d=-1,c.length&&g())}function g(){if(!u){var e=a(l);u=!0;for(var t=c.length;t;){for(i=c,c=[];++d<t;)i&&i[d].run();d=-1,t=c.length}i=null,u=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===s||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{return r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function h(e,t){this.fun=e,this.array=t}function p(){}n.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];c.push(new h(e,t)),1!==c.length||u||a(g)},h.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=p,n.addListener=p,n.once=p,n.off=p,n.removeListener=p,n.removeAllListeners=p,n.emit=p,n.prependListener=p,n.prependOnceListener=p,n.listeners=function(e){return[]},n.binding=function(e){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(e){throw new Error("process.chdir is not supported")},n.umask=function(){return 0}},84:e=>{"use strict";e.exports=require("assert")},637:e=>{"use strict";e.exports=require("babel-core/register")},464:e=>{"use strict";e.exports=require("util")}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var s=t[n]={exports:{}};return e[n](s,s.exports,r),s.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r(637),r(75)})();